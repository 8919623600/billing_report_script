# billing_report_script

The below script we can set it on crontab -e by inserting the command
0 9 * * * /path/biling-report-script.sh



###################

#!/bin/bash

# Set the service account to impersonate
gcloud config set auth/impersonate_service_account "SERVICE_ACCOUNT_NAME"

# Extract the application name from the command line arguments
appname=$1

# Run the BigQuery stored procedure
bq query "call demo.test_stored_proc('$appname')"


################

create or replace procedure demo.test_stored_proc (app_name string)

BEGIN

EXPORT DATA OPTIONS (
  url='gs://bucket/folder/*.csv' ,
   format='CSV' ,
   overwrite=true,
   header=true,
   field_delimiter=',') AS
SELECT billing_account_id, currency,SUM(cost) as total_cost,labels.value as Application
FROM 'billing_info.gcp_billing_export_xyz_abc'
LEFT JOIN UNNEST (labels) as labels
  ON labels.value = app_name
WHERE
cast (usage_start_time as date) >= date_add(current_date(), INTERNAL -8 day)
and cast (usage_end_time as date) <= date_add (current_date(), INTERVAL -2 day)
GROUP BY Application,billing_account_id,currency;


END;

####################################

Description of bigquery code below - 

The SQL query within the stored procedure test_stored_proc performs several operations on data stored in a BigQuery table ((billing_info.gcp_billing_export_v1_xyz_abc)
- First it selects four columns: billing_account_id, currency, SUM(cost) as total_cost, and labels.value as Application.(Note : We can include as many columns as per the requirement)
- It specifies the table billing_info.gcp_billing_export_xyz_abc from which the data is retrieved.
- It performs a LEFT JOIN operation with the labels array field, which is unnested to join with the app_name parameter passed to the stored procedure. This means that it will include all rows from the left table (billing_info.gcp_billing_export_xyz_abc) and matching rows from the right table (labels) based on the condition specified in the ON clause.
- It filters the data based on two conditions as per the requirement:
    * usage_start_time is within the last 8 days from the current date.
    * usage_end_time is within the interval from 2 days ago to the current date.(As per requirement we need data for last 7days where end date should be day before yesterday from the script execution date.)
- It groups the result set by the Application, billing_account_id, and currency columns.

The query retrieves data from the BigQuery table generated by GCP after enabling the Billing Export feature, performs a left join operation with an unnested array field, applies filtering conditions, calculates the sum of the cost column, and groups the result by specific columns. The result set is then used for further processing or export, as defined in the stored procedure.

Once we get the csv file on cloud storage, we can convert it to excel if required to check the report.
